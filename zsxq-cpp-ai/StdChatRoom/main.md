# C++ 多人聊天室项目学习指南

## 1. 项目概述

这是一个基于C++开发的客户端-服务器（Client-Server）架构的命令行多人聊天室项目。它通过使用Socket进行网络通信，并利用多线程技术支持多用户并发在线。

**核心功能包括：**

*   **用户系统**: 支持多用户注册、登录和登出。
*   **实时聊天**: 实现公屏群聊和指定用户的私聊。
*   **状态管理**: 可以查看当前在线的用户列表。
*   **文件传输**: 支持群文件共享和用户间的私密文件传输。
*   **数据持久化**: 用户信息和文件元数据能够被保存在本地文件中，使得服务器重启后数据不会丢失。

该项目麻雀虽小五脏俱全，是学习C++网络编程、多线程处理和面向对象设计的绝佳实践案例。

---

## 2. 通过本项目可以学到的知识点

对于新手和有一定经验的开发者，这个项目都提供了宝贵的学习机会：

*   **网络编程 (Socket API)**
    *   学习和实践基于 `socket` 的TCP网络编程，包括 `socket()`, `bind()`, `listen()`, `accept()`, `connect()`, `send()`, `recv` 等核心函数的使用。
    *   理解客户端与服务器之间三次握手和四次挥手的基本过程。
    *   学习如何设计一个简单的应用层通信协议（如本项目中的 `Message` 类）。

*   **多线程编程 (`<thread>`)**
    *   学习使用C++11的 `<thread>` 库来创建和管理线程，实现并发服务器。
    *   理解为何需要为每个客户端连接创建一个独立的线程进行处理。
    *   学习使用互斥锁 (`<mutex>`) 来保护共享资源（如用户列表、文件列表），避免多线程环境下的数据竞争问题。

*   **面向对象设计 (OOP)**
    *   学习如何将一个复杂的系统拆分为多个职责明确的类，如 `User`, `Message`, `ChatServer`, `ChatClient` 等。
    *   理解类之间的封装、继承和多态思想。
    *   体会"高内聚、低耦合"的设计原则如何让代码更易于维护和扩展。

*   **C++ 语言特性**
    *   **STL容器**: 大量使用了 `string`, `vector`, `unordered_map` 等标准模板库，是熟悉它们的绝佳机会。
    *   **文件I/O**: 学习如何使用 `<fstream>` 进行文件读写，实现数据的持久化。
    *   **枚举类 (`enum class`)**: 学习使用强类型枚举来定义消息类型、用户状态等，增强代码的可读性和类型安全。
    *   **智能指针与RAII**: 虽然本项目直接管理资源，但可以思考如何用智能指针 (`unique_ptr`, `shared_ptr`) 来改进资源管理。

*   **项目构建与管理**
    *   学习使用 `Makefile` 来自动化编译流程，管理源文件之间的依赖关系。
    *   理解大型C++项目的基本组织结构（头文件`.h`与源文件`.cpp`分离）。

---

## 3. 项目结构拆分讲解

整个项目可以按照职责分为以下几个模块：

### 模块一：核心数据类 (Core Data Classes)

这些类是构成系统的基本数据单元，负责定义数据结构。

*   `Message` (`Message.h`, `Message.cpp`): **通信协议的化身**。它定义了客户端和服务器之间所有交换信息的格式，包括消息类型（登录、聊天、文件等）、发送者、接收者和内容。`serialize` 和 `deserialize` 方法是网络传输的关键。
*   `User` (`User.h`, `User.cpp`): **用户信息的抽象**。存储了用户的账号、密码（加密后）、状态等信息。
*   `FileInfo` (`FileInfo.h`, `FileInfo.cpp`): **文件元数据的抽象**。描述了一个共享文件的所有属性，如文件名、大小、上传者等。`FileTransferSession` 则用于跟踪私聊文件传输的状态。

### 模块二：管理类 (Manager Classes)

这些是服务器端的逻辑核心，负责管理数据和执行主要业务。

*   `UserManager` (`UserManager.h`, `UserManager.cpp`): **用户大管家**。负责所有用户的注册、登录验证、登出处理和在线状态维护。它持有一个用户列表，并使用互斥锁来保证多线程访问的安全性。
*   `FileManager` (`FileManager.h`, `FileManager.cpp`): **文件大管家**。负责处理所有与文件相关的操作，包括群文件的上传下载、私聊文件传输会话的建立与管理等。

### 模块三：网络核心类 (Network Core Classes)

这些类是客户端和服务器的骨架，负责网络通信的建立和维护。

*   `ChatServer` (`ChatServer.h`, `ChatServer.cpp`): **服务器的总指挥**。
    1.  初始化并监听一个网络端口。
    2.  进入 `acceptLoop` 循环，等待客户端的连接。
    3.  每当有新客户端连接，就为其创建一个新的`std::thread`，并指定 `handleClient` 函数进行处理。
    4.  在 `handleClient` 中，循环接收客户端消息，并根据 `Message` 的类型分发给不同的处理函数（如 `handleLogin`, `handlePublicChat` 等）。
*   `ChatClient` (`ChatClient.h`, `ChatClient.cpp`): **客户端的总指挥**。
    1.  连接到服务器。
    2.  启动一个独立的 `receiveThread` 线程，专门负责接收并处理来自服务器的消息。
    3.  主线程则负责接收用户的键盘输入，并将其打包成 `Message` 发送给服务器。
    4.  这种"收发分离"的设计模式是网络客户端编程的典型实践。

### 模块四：主程序入口 (Main Entry Points)

*   `server_main.cpp`: **服务器程序的起点**。代码非常简单，主要就是创建一个 `ChatServer` 对象，然后调用其 `start()` 方法。
*   `client_main.cpp`: **客户端程序的起点**。同样非常简单，创建一个 `ChatClient` 对象，然后调用其 `run()` 方法。

---

## 4. 如何快速上手

### 第一步：编译与运行

1.  **确保环境**: 你需要一个Linux环境和`g++`编译器以及`make`工具。
2.  **编译**: 在项目根目录下，直接运行 `make` 命令。
    ```bash
    make
    ```
    这将生成 `server` 和 `client` 两个可执行文件。
3.  **运行**:
    *   先在第一个终端窗口启动服务器：`./server`
    *   再打开一个或多个新的终端窗口，启动客户端：`./client`
4.  **体验**: 按照客户端的提示进行注册、登录、聊天等操作，感受系统的功能。

### 第二步：代码阅读建议

1.  **从`README.md`开始**: 通读`README.md`以建立对项目的宏观认识。
2.  **从头文件入手**: 按以下顺序阅读头文件，理解每个类的"职责"是什么：
    *   `Message.h` -> `User.h` -> `FileInfo.h` (理解数据基础)
    *   `UserManager.h` -> `FileManager.h` (理解管理逻辑)
    *   `ChatServer.h` -> `ChatClient.h` (理解网络框架)
3.  **跟踪一条主线**: 选择一个核心功能，例如"用户登录"，然后跟踪代码的执行流程：
    *   从 `client_main.cpp` -> `ChatClient::run()` -> `handleLoginRegister()` 看客户端如何发送登录消息。
    *   再到 `server_main.cpp` -> `ChatServer::start()` -> `acceptLoop()` -> `handleClient()` -> `handleMessage()` -> `handleLogin()` 看服务器如何处理登录请求并返回响应。
    *   通过这种方式可以快速将各个模块串联起来。
4.  **关注多线程安全**: 在阅读 `UserManager` 和 `FileManager` 的 `.cpp` 文件时，特别留意 `std::mutex` 和 `std::lock_guard` 的使用，理解它们是如何保护共享数据的。

### 第三步：功能扩展建议

在理解项目的基础上，可以尝试自己动手添加新功能，这是最好的学习方式：

*   **聊天记录保存**: 在服务器端，将公共和私人聊天记录写入文件。
*   **支持表情包**: 扩展 `Message` 协议，增加一种表情消息类型。
*   **数据库集成**: 将 `UserManager` 的后端从文件存储（`users.dat`）替换为 `MySQL` 或 `SQLite` 数据库。
*   **增加UI界面**: 使用 `Qt`等图形库为客户端创建一个图形用户界面，替代当前的命令行界面。
